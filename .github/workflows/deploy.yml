name: Deploy InFinea (Backend Render + Frontend Vercel)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-backend:
    name: Deploy Backend to Render
    runs-on: ubuntu-latest
    steps:
      - name: Trouver le service Render
        id: find_service
        run: |
          RESPONSE=$(curl -s "https://api.render.com/v1/services?name=infinea-api&limit=1" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}")
          SERVICE_ID=$(echo "$RESPONSE" | python3 -c "
          import sys,json
          try:
              s = json.load(sys.stdin)
              print(s[0]['service']['id'] if s else '')
          except Exception as e:
              print('')
          " 2>/dev/null)
          echo "service_id=$SERVICE_ID" >> $GITHUB_OUTPUT
          echo "Service: $SERVICE_ID"
          if [ -z "$SERVICE_ID" ]; then
            echo "⚠️ Service non trouvé, vérifiez RENDER_API_KEY"
          fi

      - name: Configurer le service (branche + commandes)
        if: steps.find_service.outputs.service_id != ''
        run: |
          SERVICE_ID="${{ steps.find_service.outputs.service_id }}"
          curl -s -X PATCH "https://api.render.com/v1/services/$SERVICE_ID" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "branch": "main",
              "autoDeploy": "yes",
              "serviceDetails": {
                "envSpecificDetails": {
                  "buildCommand": "pip install -r requirements-deploy.txt",
                  "startCommand": "uvicorn server:app --host 0.0.0.0 --port $PORT"
                }
              }
            }' > /dev/null

      - name: Configurer les env vars (ajout individuel, sans écraser)
        if: steps.find_service.outputs.service_id != ''
        run: |
          SERVICE_ID="${{ steps.find_service.outputs.service_id }}"
          set_env() {
            local key=$1 value=$2
            if [ -n "$value" ] && [ "$value" != "" ]; then
              curl -s -X PUT "https://api.render.com/v1/services/$SERVICE_ID/env-vars/$key" \
                -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
                -H "Content-Type: application/json" \
                -d "{\"value\":\"$value\"}" > /dev/null
              echo "  ✓ $key"
            else
              echo "  ⏭ $key (non défini dans les secrets)"
            fi
          }
          echo "Mise à jour des env vars..."
          set_env "GOOGLE_CLIENT_ID" "${{ secrets.GOOGLE_CLIENT_ID }}"
          set_env "GOOGLE_CLIENT_SECRET" "${{ secrets.GOOGLE_CLIENT_SECRET }}"
          set_env "BACKEND_URL" "${{ secrets.BACKEND_URL }}"
          set_env "FRONTEND_URL" "${{ secrets.FRONTEND_URL }}"
          set_env "MONGO_URL" "${{ secrets.MONGO_URL }}"
          set_env "JWT_SECRET" "${{ secrets.JWT_SECRET }}"
          set_env "ANTHROPIC_API_KEY" "${{ secrets.ANTHROPIC_API_KEY }}"
          set_env "ALLOWED_ORIGINS" "https://infinea.vercel.app,http://localhost:3000"

      - name: Déclencher le déploiement
        id: deploy
        if: steps.find_service.outputs.service_id != ''
        run: |
          SERVICE_ID="${{ steps.find_service.outputs.service_id }}"
          sleep 3
          BODY=$(curl -s -X POST "https://api.render.com/v1/services/$SERVICE_ID/deploys" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache":"do_not_clear"}')
          echo "API response: $BODY"
          DEPLOY_ID=$(echo "$BODY" | python3 -c "
          import sys,json
          try:
              d = json.load(sys.stdin)
              print(d.get('id', ''))
          except:
              print('')
          " 2>/dev/null)
          echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
          if [ -n "$DEPLOY_ID" ]; then
            echo "✅ Deploy déclenché: $DEPLOY_ID"
          else
            echo "⚠️ Deploy non déclenché (autoDeploy peut gérer)"
          fi

      - name: Attendre le build (max 5min)
        if: steps.deploy.outputs.deploy_id != ''
        run: |
          SERVICE_ID="${{ steps.find_service.outputs.service_id }}"
          DEPLOY_ID="${{ steps.deploy.outputs.deploy_id }}"
          for i in $(seq 1 30); do
            sleep 10
            STATUS=$(curl -s "https://api.render.com/v1/services/$SERVICE_ID/deploys/$DEPLOY_ID" \
              -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
              | python3 -c "
          import sys,json
          try:
              print(json.load(sys.stdin).get('status','unknown'))
          except:
              print('unknown')
          " 2>/dev/null)
            echo "[$i/30] $STATUS"
            case "$STATUS" in
              live) echo "✅ Deploy réussi !" && exit 0 ;;
              build_failed|update_failed|canceled|deactivated)
                echo "❌ ÉCHEC: $STATUS"
                exit 1 ;;
            esac
          done
          echo "⏱ Timeout après 5min — vérifiez sur dashboard.render.com"

  deploy-frontend:
    name: Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    if: ${{ secrets.VERCEL_TOKEN != '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install & Deploy Vercel
        run: |
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "⏭ VERCEL_TOKEN non configuré, skip deploy frontend"
            echo "ℹ️ Vercel auto-deploy depuis GitHub gère le frontend"
            exit 0
          fi
          npm install -g vercel
          cd frontend
          vercel --prod --token=$VERCEL_TOKEN --yes
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
