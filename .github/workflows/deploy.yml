name: Deploy InFinea (Backend Render + Frontend Vercel)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-backend:
    name: Deploy Backend to Render
    runs-on: ubuntu-latest
    steps:
      - name: Trouver le service Render infinea-api
        id: find_service
        run: |
          RESPONSE=$(curl -s "https://api.render.com/v1/services?name=infinea-api&limit=1" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}")
          SERVICE_ID=$(echo "$RESPONSE" | python3 -c "import sys,json; s=json.load(sys.stdin); print(s[0]['service']['id'] if s else '')")
          echo "service_id=$SERVICE_ID" >> $GITHUB_OUTPUT
          echo "Service trouvé : $SERVICE_ID"

      - name: Configurer le service Render
        run: |
          SERVICE_ID="${{ steps.find_service.outputs.service_id }}"
          curl -s -X PATCH "https://api.render.com/v1/services/$SERVICE_ID" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "branch": "main",
              "autoDeploy": "yes",
              "serviceDetails": {
                "envSpecificDetails": {
                  "buildCommand": "pip install -r requirements-deploy.txt",
                  "startCommand": "uvicorn server:app --host 0.0.0.0 --port $PORT"
                }
              }
            }' | python3 -c "
          import sys,json; d=json.load(sys.stdin)
          sd=d.get('serviceDetails',{}).get('envSpecificDetails',{})
          print(f'branch={d.get(\"branch\")} build={sd.get(\"buildCommand\")} start={sd.get(\"startCommand\")}')
          " 2>/dev/null

      - name: Déclencher le déploiement
        id: deploy
        run: |
          SERVICE_ID="${{ steps.find_service.outputs.service_id }}"
          sleep 3
          BODY=$(curl -s -X POST "https://api.render.com/v1/services/$SERVICE_ID/deploys" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache":"do_not_clear"}')
          DEPLOY_ID=$(echo "$BODY" | python3 -c "import sys,json; print(json.load(sys.stdin).get('id',''))" 2>/dev/null)
          echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
          echo "Deploy ID: $DEPLOY_ID"
          echo "$BODY" | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'commit={d.get(\"commit\",{}).get(\"id\",\"?\")[:7]} status={d.get(\"status\")}')" 2>/dev/null

      - name: Attendre le build (max 5min)
        run: |
          SERVICE_ID="${{ steps.find_service.outputs.service_id }}"
          DEPLOY_ID="${{ steps.deploy.outputs.deploy_id }}"
          if [ -z "$DEPLOY_ID" ]; then
            echo "Pas de deploy ID, skip"
            exit 0
          fi
          for i in $(seq 1 30); do
            sleep 10
            STATUS=$(curl -s "https://api.render.com/v1/services/$SERVICE_ID/deploys/$DEPLOY_ID" \
              -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
              | python3 -c "import sys,json; print(json.load(sys.stdin).get('status','unknown'))" 2>/dev/null)
            echo "[$i/30] Status: $STATUS"
            if [ "$STATUS" = "live" ]; then
              echo "Deploy réussi !"
              exit 0
            fi
            if [ "$STATUS" = "build_failed" ] || [ "$STATUS" = "update_failed" ] || [ "$STATUS" = "canceled" ]; then
              echo "Deploy échoué avec status: $STATUS"
              echo "Récupération des logs..."
              curl -s "https://api.render.com/v1/services/$SERVICE_ID/deploys/$DEPLOY_ID/logs" \
                -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
                | python3 -c "
              import sys,json
              logs = json.load(sys.stdin)
              for entry in logs[-50:]:
                print(entry.get('message',''))
              " 2>/dev/null || echo "Impossible de récupérer les logs"
              exit 1
            fi
          done
          echo "Timeout - deploy toujours en cours après 5min"

  deploy-frontend:
    name: Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy to Vercel (Production)
        run: |
          cd frontend
          vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
